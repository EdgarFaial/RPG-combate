<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Sistema de Combate RPG - Completo</title>
<style>
  body {
    background-color: #252526;
    color: #eee;
    font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
    margin: 20px;
  }
  h1 {
    text-align: center;
  }
  .container {
    max-width: 900px;
    margin: auto;
  }
  select, button {
    margin: 10px 5px 10px 0;
    padding: 8px 12px;
    border-radius: 6px;
    border: none;
    font-weight: bold;
    cursor: pointer;
  }
  button {
    background-color: #3a3a3a;
    color: #eee;
  }
  button:hover {
    background-color: #505050;
  }
  .status {
    margin-top: 10px;
  }
  .personagem-box {
    background: #2e2e2e;
    border-radius: 8px;
    padding: 15px;
    margin: 15px 0;
  }
  .vida-bar {
    background: #444;
    height: 20px;
    border-radius: 10px;
    overflow: hidden;
    margin: 5px 0;
    position: relative;
  }
  .vida-atual {
    background: #4caf50;
    height: 100%;
    width: 100%;
    transition: width 0.3s ease;
    position: absolute;
    top: 0;
    left: 0;
  }
  .vida-texto {
    position: relative;
    z-index: 1;
    text-align: center;
    color: white;
    font-weight: bold;
    line-height: 20px;
  }
  #log {
    background-color: #1e1e1e;
    border-radius: 8px;
    padding: 15px;
    height: 300px;
    overflow-y: auto;
    white-space: pre-wrap;
    font-family: monospace;
    font-size: 14px;
    margin-top: 20px;
  }
  .flex-row {
    display: flex;
    justify-content: space-between;
  }
  .atributos {
    font-size: 13px;
    line-height: 1.3;
    margin-top: 8px;
  }
  .status-list {
    font-size: 12px;
    margin-top: 6px;
    color: #a8d0e6;
  }
  .inventario-list {
    font-size: 12px;
    margin-top: 6px;
    color: #f7d794;
  }
  .dialogo-habilidade {
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: #2e2e2e;
    padding: 20px;
    border-radius: 8px;
    z-index: 100;
    box-shadow: 0 0 10px rgba(0,0,0,0.5);
    width: 300px;
  }
  .dialogo-habilidade select {
    width: 100%;
    margin-bottom: 10px;
  }
  .dialogo-habilidade button {
    margin-right: 5px;
  }
  .overlay {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0,0,0,0.5);
    z-index: 99;
  }
  .ambiente-select {
    margin: 10px 0;
    padding: 8px;
    border-radius: 6px;
    background: #3a3a3a;
    color: #eee;
    border: none;
  }
</style>
</head>
<body>

<div class="container">
  <h1>Sistema de Combate RPG Completo</h1>

  <div>
    <label for="selPlayer1">Jogador 1:</label>
    <select id="selPlayer1"></select>

    <label for="selPlayer2">Jogador 2:</label>
    <select id="selPlayer2"></select>
    
    <label for="selAmbiente">Ambiente:</label>
    <select id="selAmbiente" class="ambiente-select">
      <option value="neutro">Neutro</option>
      <option value="fogo">Fogo</option>
      <option value="agua">Água</option>
      <option value="floresta">Floresta</option>
      <option value="montanha">Montanha</option>
      <option value="magico">Mágico</option>
      <option value="tecnologico">Tecnológico</option>
    </select>
  </div>

  <div>
    <button id="btnIniciar">Iniciar Combate</button>
    <button id="btnTurno" disabled>Próximo Turno</button>
    <button id="btnUsarHabilidade" disabled>Usar Habilidade</button>
    <button id="btnUsarItem" disabled>Usar Item</button>
    <button id="btnReiniciar" disabled>Reiniciar</button>
  </div>

  <div class="flex-row">
    <div class="personagem-box" id="boxPlayer1">
      <h2>Jogador 1</h2>
      <div><b>Nome:</b> <span id="nomePlayer1">-</span></div>
      <div><b>Vida:</b> <span id="vidaNum1">-</span></div>
      <div class="vida-bar">
        <div id="vidaBar1" class="vida-atual"></div>
        <div class="vida-texto" id="vidaTexto1"></div>
      </div>
      <div class="atributos" id="atributos1"></div>
      <div class="status-list" id="status1"></div>
      <div class="inventario-list" id="inventario1"></div>
    </div>

    <div class="personagem-box" id="boxPlayer2">
      <h2>Jogador 2</h2>
      <div><b>Nome:</b> <span id="nomePlayer2">-</span></div>
      <div><b>Vida:</b> <span id="vidaNum2">-</span></div>
      <div class="vida-bar">
        <div id="vidaBar2" class="vida-atual"></div>
        <div class="vida-texto" id="vidaTexto2"></div>
      </div>
      <div class="atributos" id="atributos2"></div>
      <div class="status-list" id="status2"></div>
      <div class="inventario-list" id="inventario2"></div>
    </div>
  </div>

  <div id="log"></div>
</div>

<script>
(() => {
  // Personagens base com atributos, habilidades, inventário, raça e classe
  const personagensBase = {
    mu: {
      nome: "Mu",
      raca: "aerolino",
      classe: "ladino",
      atributosBase: { forca: 3, velocidade: 8, inteligencia: 4, determinacao: 0, resistencia: 1 },
      habilidades: {
        frenesiEsquivas: { nome: "Frenesi de Esquivas", passiva: true, esquivasConsecutivas: 0, bonusVelocidade: 0 },
        arrastao: { nome: "Arrastão", cooldown: 0, usos: 2, maxUsos: 2 }
      },
      inventario: [
        { nome: "Rapieira Nobre", tipo: "arma", descricao: "Escala com velocidade (+força = velocidade/3)." }
      ]
    },
    malgorr: {
      nome: "Malgorr",
      raca: "terroso",
      classe: "mago",
      atributosBase: { forca: 0, velocidade: 0, inteligencia: 0, determinacao: 5, resistencia: 10 },
      habilidades: {
        vantagemElemental: { nome: "Vantagem Elemental", cooldown: 0, ativo: false },
        tecelaoCarcacas: { nome: "Tecelão de Carcaças", cooldown: 0, usado: false }
      },
      inventario: [
        { nome: "Catalisador", tipo: "item", descricao: "Escudo especial após 2 turnos de inatividade.", preparando: 0 }
      ]
    },
    samuw: {
      nome: "Samuw Buoynm",
      raca: "monguey",
      classe: "guerreiroMago",
      atributosBase: { forca: 8, velocidade: 5, inteligencia: 0, determinacao: 5, resistencia: 5 },
      habilidades: {
        palmaSanta: { nome: "Palma Santa", cooldown: 0, usos: 3, maxUsos: 3 },
        kingMonkey: { nome: "King Monkey", cooldown: 0, ativo: false, duracao: 0 }
      },
      inventario: [
        { nome: "Luvas Solares", tipo: "arma", descricao: "+2 força, acumula dano", cooldown: 0, danoAcumulado: 0 }
      ]
    },
    lior: {
      nome: "Lior Vaelstrom",
      raca: "aeralino",
      classe: "tecnomago",
      atributosBase: { forca: 0, velocidade: 0, inteligencia: 7, determinacao: 7, resistencia: 1 },
      habilidades: {
        criarArtefatos: { nome: "Criar Artefatos", cooldown: 0, usos: 2, maxUsos: 2 },
        usarForcaMagica: { nome: "Usar Força Mágica", cooldown: 0, ativo: false, duracao: 0 }
      },
      inventario: [
        { nome: "Manopla Etherflux", tipo: "artefato", descricao: "Canalizador e interface tecnológica.", preparada: true }
      ]
    },
    adam: {
      nome: "Adam",
      raca: "aerolino",
      classe: "ladino",
      atributosBase: { forca: 4, velocidade: 1, inteligencia: 2, determinacao: 2, resistencia: 6 },
      habilidades: {
        sentirPresenca: { nome: "Sentir Presença", passiva: true },
        invisibilidade: { nome: "Invisibilidade", cooldown: 0, duracao: 0, usos: 1, maxUsos: 1 }
      },
      inventario: [
        { nome: "Adagas Duplas", tipo: "arma", descricao: "Ataques furtivos + veneno", venenoUsado: false }
      ]
    }
  };

  // Bônus de raça e classe
  const bonusRaca = {
    aerolino: { velocidade: 2, resistencia: -2 },
    terroso: { resistencia: 2, velocidade: -2 },
    monguey: { forca: 1, velocidade: 1, inteligencia: -1 },
    aeralino: { velocidade: 2, resistencia: -2 },
    arryano: { inteligencia: 2, destreza: -2 },
    semideus: { forca: 2, inteligencia: -2 }
  };

  const bonusClasse = {
    guerreiro: { forca: 4 },
    ladino: { velocidade: 4 },
    mago: { determinacao: 4 },
    engenheiro: { inteligencia: 4 },
    guerreiroMago: { forca: 2, determinacao: 2 },
    tecnomago: { inteligencia: 2, determinacao: 2 }
  };

  // Ambientes e seus efeitos
  const ambientes = {
    neutro: { nome: "Neutro", bonus: {} },
    fogo: { 
      nome: "Fogo", 
      bonus: { 
        mago: { determinacao: 2 },
        tecnomago: { inteligencia: 1 }
      } 
    },
    agua: { 
      nome: "Água", 
      bonus: { 
        mago: { determinacao: 1 },
        tecnomago: { inteligencia: -1 }
      } 
    },
    floresta: { 
      nome: "Floresta", 
      bonus: { 
        ladino: { velocidade: 1 },
        guerreiro: { forca: 1 }
      } 
    },
    montanha: { 
      nome: "Montanha", 
      bonus: { 
        terroso: { resistencia: 1 },
        guerreiro: { forca: 1 }
      } 
    },
    magico: { 
      nome: "Mágico", 
      bonus: { 
        mago: { determinacao: 3 },
        tecnomago: { inteligencia: 3 }
      } 
    },
    tecnologico: { 
      nome: "Tecnológico", 
      bonus: { 
        tecnomago: { inteligencia: 2 },
        mago: { determinacao: -1 }
      } 
    }
  };

  // Estado do jogo
  let ambienteAtual = "neutro";
  let estadoJogador = {
    player1: null,
    player2: null
  };
  let turno = 0;
  let combateAtivo = false;
  let dialogoHabilidadeAberto = false;

  // Auxiliares de dados
  function rolarDado(lados) {
    return Math.floor(Math.random() * lados) + 1;
  }

  // Clona personagem base e aplica bônus
  function criarPersonagem(chave) {
    if (!personagensBase[chave]) return null;
    const base = JSON.parse(JSON.stringify(personagensBase[chave])); // clone profundo

    // Aplica bônus raça
    const br = bonusRaca[base.raca.toLowerCase()] || {};
    // Aplica bônus classe
    const bc = bonusClasse[base.classe.toLowerCase()] || {};

    // Inicializa atributos com base
    let atributos = { ...base.atributosBase };

    // Aplica bônus raça
    for (const k in br) {
      if (atributos.hasOwnProperty(k)) atributos[k] += br[k];
      else atributos[k] = br[k];
    }
    // Aplica bônus classe
    for (const k in bc) {
      if (atributos.hasOwnProperty(k)) atributos[k] += bc[k];
      else atributos[k] = bc[k];
    }

    // Calcula vida máxima: conforme especificado para cada personagem
    let vidaMax;
    switch(chave) {
      case 'mu': vidaMax = 90; break;
      case 'malgorr': vidaMax = 160; break;
      case 'samuw': vidaMax = 150; break;
      case 'lior': vidaMax = 90; break;
      case 'adam': vidaMax = 140; break;
      default: vidaMax = 100 + (atributos.resistencia * 10);
    }

    return {
      nome: base.nome,
      raca: base.raca,
      classe: base.classe,
      atributos,
      vidaMax,
      vida: vidaMax,
      habilidades: JSON.parse(JSON.stringify(base.habilidades)),
      inventario: JSON.parse(JSON.stringify(base.inventario)),
      status: [], // status ativos (ex: invisível, envenenado)
      esquivasConsecutivas: 0 // específico para Mu
    };
  }

  // Aplica bônus do ambiente
  function aplicarBonusAmbiente(jogador) {
    const ambiente = ambientes[ambienteAtual];
    if (!ambiente || !ambiente.bonus) return;
    
    const bonus = ambiente.bonus[jogador.classe.toLowerCase()] || {};
    for (const attr in bonus) {
      jogador.atributos[attr] += bonus[attr];
    }
  }

  // Atualiza a interface de um jogador
  function atualizarInterface() {
    ["player1", "player2"].forEach((key, idx) => {
      const p = estadoJogador[key];
      if (!p) {
        document.getElementById(`nomePlayer${idx + 1}`).innerText = "-";
        document.getElementById(`vidaNum${idx + 1}`).innerText = "-";
        document.getElementById(`vidaBar${idx + 1}`).style.width = "0%";
        document.getElementById(`vidaTexto${idx + 1}`).innerText = "";
        document.getElementById(`atributos${idx + 1}`).innerText = "";
        document.getElementById(`status${idx + 1}`).innerText = "";
        document.getElementById(`inventario${idx + 1}`).innerText = "";
        return;
      }
      
      const num = idx + 1;
      document.getElementById(`nomePlayer${num}`).innerText = p.nome;
      const vidaAtual = p.vida > 0 ? p.vida : 0;
      document.getElementById(`vidaNum${num}`).innerText = vidaAtual;
      const percVida = (vidaAtual / p.vidaMax) * 100;
      document.getElementById(`vidaBar${num}`).style.width = percVida + "%";
      document.getElementById(`vidaTexto${num}`).innerText = `${vidaAtual}/${p.vidaMax}`;

      // Cor da barra de vida baseada na porcentagem
      const vidaBar = document.getElementById(`vidaBar${num}`);
      if (percVida > 60) {
        vidaBar.style.backgroundColor = "#4caf50"; // Verde
      } else if (percVida > 30) {
        vidaBar.style.backgroundColor = "#ff9800"; // Laranja
      } else {
        vidaBar.style.backgroundColor = "#f44336"; // Vermelho
      }

      const attr = p.atributos;
      document.getElementById(`atributos${num}`).innerHTML = `
        <b>Atributos:</b> Força: ${attr.forca}, Velocidade: ${attr.velocidade}, Inteligência: ${attr.inteligencia}, Determinação: ${attr.determinacao}, Resistência: ${attr.resistencia}
      `;

      // Status ativos
      let statusTxt = "Status: ";
      if (p.status.length === 0) statusTxt += "Nenhum";
      else {
        statusTxt += p.status.map(s => `${s.nome} (${s.turnosRestantes} turnos)`).join(", ");
      }
      document.getElementById(`status${num}`).innerText = statusTxt;

      // Inventário
      if (p.inventario.length === 0) {
        document.getElementById(`inventario${num}`).innerText = "Inventário vazio";
      } else {
        document.getElementById(`inventario${num}`).innerText =
          "Inventário: " + p.inventario.map(i => {
            let extra = "";
            if (i.usos !== undefined) extra = ` (${i.usos}/${i.maxUsos})`;
            if (i.cooldown !== undefined && i.cooldown > 0) extra = ` (CD: ${i.cooldown})`;
            return i.nome + extra;
          }).join(", ");
      }

      // Habilidades (mostra usos/cooldown)
      const habilidadesDiv = document.createElement("div");
      habilidadesDiv.className = "habilidades-list";
      habilidadesDiv.innerHTML = "<b>Habilidades:</b> " + 
        Object.values(p.habilidades).map(h => {
          if (h.passiva) return `${h.nome} (Passiva)`;
          let extra = "";
          if (h.usos !== undefined) extra = ` (${h.usos}/${h.maxUsos})`;
          if (h.cooldown > 0) extra = ` (CD: ${h.cooldown})`;
          if (h.ativo) extra = " (Ativo)";
          return h.nome + extra;
        }).join(", ");
      
      const oldHabilidades = document.querySelector(`#boxPlayer${num} .habilidades-list`);
      if (oldHabilidades) oldHabilidades.remove();
      document.getElementById(`boxPlayer${num}`).appendChild(habilidadesDiv);
    });
  }

  // Função para adicionar texto ao log
  function logTexto(texto) {
    const log = document.getElementById("log");
    log.innerText += texto + "\n";
    log.scrollTop = log.scrollHeight;
  }

  // Função para aplicar efeitos de status por turno
  function processarStatus(p) {
    let log = "";

    // Processa status do personagem
    let statusParaRemover = [];
    for (const st of p.status) {
      if (st.nome === "Envenenado") {
        const dano = 5;
        p.vida -= dano;
        log += `${p.nome} sofre ${dano} de dano por envenenamento.\n`;
        st.turnosRestantes--;
        if (st.turnosRestantes <= 0) statusParaRemover.push(st);
      }
      else if (st.nome === "Invisibilidade") {
        st.turnosRestantes--;
        if (st.turnosRestantes <= 0) {
          statusParaRemover.push(st);
          log += `${p.nome} perdeu a invisibilidade.\n`;
        }
      }
      else if (st.nome === "King Monkey") {
        st.turnosRestantes--;
        if (st.turnosRestantes <= 0) {
          // Reverte os bônus
          p.atributos.forca -= 3;
          p.atributos.resistencia -= 3;
          p.atributos.velocidade += 2;
          statusParaRemover.push(st);
          p.habilidades.kingMonkey.ativo = false;
          log += `${p.nome} voltou à forma normal após King Monkey.\n`;
        }
      }
      else if (st.nome === "Usar Força Mágica") {
        st.turnosRestantes--;
        if (st.turnosRestantes <= 0) {
          p.atributos.inteligencia -= p.habilidades.usarForcaMagica.bonus;
          statusParaRemover.push(st);
          p.habilidades.usarForcaMagica.ativo = false;
          log += `${p.nome} perdeu o bônus de Força Mágica.\n`;
        }
      }
      else if (st.nome === "Preparando Catalisador") {
        st.turnosRestantes--;
        if (st.turnosRestantes <= 0) {
          statusParaRemover.push(st);
          p.status.push({ nome: "Escudo Ativo", turnosRestantes: 3 });
          log += `${p.nome} ativou o escudo do Catalisador por 3 turnos!\n`;
        } else {
          log += `${p.nome} está preparando o Catalisador (${st.turnosRestantes} turnos restantes).\n`;
        }
      }
      else if (st.nome === "Escudo Ativo") {
        st.turnosRestantes--;
        if (st.turnosRestantes <= 0) {
          statusParaRemover.push(st);
          log += `${p.nome} perdeu o escudo do Catalisador.\n`;
        }
      }
      else if (st.nome === "Dano Acumulado") {
        // Luvas Solares - libera o dano acumulado
        const luvas = p.inventario.find(i => i.nome === "Luvas Solares");
        if (luvas && luvas.danoAcumulado > 0) {
          const dano = luvas.danoAcumulado;
          luvas.danoAcumulado = 0;
          log += `${p.nome} liberou ${dano} de dano acumulado das Luvas Solares!\n`;
          // Encontra o inimigo
          const inimigoKey = p === estadoJogador.player1 ? "player2" : "player1";
          const inimigo = estadoJogador[inimigoKey];
          if (inimigo && inimigo.vida > 0) {
            inimigo.vida -= dano;
            if (inimigo.vida < 0) inimigo.vida = 0;
            log += `${inimigo.nome} sofreu ${dano} de dano!\n`;
          }
        }
        statusParaRemover.push(st);
      }
      else {
        // Outras condições aqui
        st.turnosRestantes--;
        if (st.turnosRestantes <= 0) statusParaRemover.push(st);
      }
    }

    // Remove status expirados
    p.status = p.status.filter(s => !statusParaRemover.includes(s));
    
    // Processa cooldowns de itens
    for (const item of p.inventario) {
      if (item.cooldown && item.cooldown > 0) {
        item.cooldown--;
      }
    }
    
    // Processa cooldowns de habilidades
    for (const hab of Object.values(p.habilidades)) {
      if (hab.cooldown && hab.cooldown > 0) {
        hab.cooldown--;
      }
    }
    
    return log;
  }

  // Verifica se um personagem tem escudo ativo
  function temEscudo(p) {
    return p.status.some(s => s.nome === "Escudo Ativo");
  }

  // Verifica se um personagem é Mu
  function ehMu(p) {
    return p && p.nome === "Mu";
  }

  // Verifica se um personagem está invisível
  function estaInvisivel(p) {
    return p.status.some(s => s.nome === "Invisibilidade");
  }

  // Mostra diálogo para selecionar habilidade
  function mostrarDialogoHabilidades(jogador) {
    if (dialogoHabilidadeAberto) return;
    dialogoHabilidadeAberto = true;
    
    const dialog = document.createElement("div");
    dialog.className = "dialogo-habilidade";
    
    const overlay = document.createElement("div");
    overlay.className = "overlay";
    
    const titulo = document.createElement("h3");
    titulo.innerText = `${jogador.nome} - Escolha uma habilidade`;
    dialog.appendChild(titulo);
    
    const select = document.createElement("select");
    select.id = "selectHabilidade";
    
    // Filtra apenas habilidades ativas (não passivas)
    const habilidadesAtivas = Object.values(jogador.habilidades).filter(h => !h.passiva);
    
    if (habilidadesAtivas.length === 0) {
      const option = document.createElement("option");
      option.value = "";
      option.text = "Nenhuma habilidade disponível";
      select.appendChild(option);
      select.disabled = true;
    } else {
      habilidadesAtivas.forEach(h => {
        let disponivel = true;
        let motivo = "";
        
        if (h.usos !== undefined && h.usos <= 0) {
          disponivel = false;
          motivo = " (Sem usos)";
        } else if (h.cooldown > 0) {
          disponivel = false;
          motivo = ` (CD: ${h.cooldown})`;
        } else if (h.ativo) {
          disponivel = false;
          motivo = " (Ativo)";
        }
        
        const option = document.createElement("option");
        option.value = h.nome;
        option.text = h.nome + motivo;
        option.disabled = !disponivel;
        select.appendChild(option);
      });
    }
    
    dialog.appendChild(select);
    
    const botoesDiv = document.createElement("div");
    botoesDiv.style.marginTop = "10px";
    
    const btnUsar = document.createElement("button");
    btnUsar.innerText = "Usar";
    btnUsar.onclick = () => {
      const habNome = select.value;
      if (habNome) {
        usarHabilidadeSelecionada(jogador, habNome);
      }
      fecharDialogo();
    };
    
    const btnCancelar = document.createElement("button");
    btnCancelar.innerText = "Cancelar";
    btnCancelar.onclick = fecharDialogo;
    
    botoesDiv.appendChild(btnUsar);
    botoesDiv.appendChild(btnCancelar);
    dialog.appendChild(botoesDiv);
    
    document.body.appendChild(overlay);
    document.body.appendChild(dialog);
    
    function fecharDialogo() {
      document.body.removeChild(overlay);
      document.body.removeChild(dialog);
      dialogoHabilidadeAberto = false;
    }
  }

  // Usa a habilidade selecionada no diálogo
  function usarHabilidadeSelecionada(jogador, habNome) {
    const habKey = Object.keys(jogador.habilidades).find(k => jogador.habilidades[k].nome === habNome);
    if (!habKey) return;
    
    const hab = jogador.habilidades[habKey];
    let log = "";
    
    switch (habKey) {
      case "arrastao":
        if (hab.usos <= 0) {
          logTexto(`${jogador.nome} não tem mais usos de Arrastão.`);
          return;
        }
        
        const defensorKey = jogador === estadoJogador.player1 ? "player2" : "player1";
        const defensor = estadoJogador[defensorKey];
        
        if (!defensor || defensor.inventario.length === 0) {
          logTexto(`${jogador.nome} tentou roubar, mas ${defensor ? defensor.nome : "o adversário"} não tem itens.`);
          return;
        }
        
        const dado = rolarDado(20);
        logTexto(`${jogador.nome} tenta Arrastão: d20(${dado})`);
        
        if (dado >= 11) {
          const item = defensor.inventario.shift();
          jogador.inventario.push(item);
          hab.usos--;
          logTexto(`${jogador.nome} roubou o item ${item.nome} de ${defensor.nome}!`);
        } else {
          hab.usos--;
          logTexto(`${jogador.nome} falhou no Arrastão!`);
        }
        break;
        
      case "invisibilidade":
        if (estaInvisivel(jogador)) {
          logTexto(`${jogador.nome} já está invisível.`);
          return;
        }
        jogador.status.push({ nome: "Invisibilidade", turnosRestantes: 1 });
        hab.usos--;
        log = `${jogador.nome} ativou Invisibilidade por 1 turno!`;
        break;
        
      case "vantagemElemental":
        if (hab.ativo) {
          logTexto(`${jogador.nome} já está com Vantagem Elemental ativa.`);
          return;
        }
        hab.ativo = true;
        jogador.atributos.velocidade += 2;
        log = `${jogador.nome} ativou Vantagem Elemental! +2 de dano e +2 de velocidade em ambiente ${ambienteAtual}.`;
        break;
        
      case "palmaSanta":
        if (hab.usos <= 0) {
          logTexto(`${jogador.nome} não tem mais usos de Palma Santa.`);
          return;
        }
        const cura = Math.floor(jogador.vidaMax * 0.5);
        jogador.vida += cura;
        if (jogador.vida > jogador.vidaMax) jogador.vida = jogador.vidaMax;
        hab.usos--;
        log = `${jogador.nome} usou Palma Santa e recuperou ${cura} de vida.`;
        break;
        
      case "kingMonkey":
        if (hab.ativo) {
          logTexto(`${jogador.nome} já está em forma de King Monkey.`);
          return;
        }
        hab.ativo = true;
        hab.duracao = 2;
        jogador.atributos.forca += 3;
        jogador.atributos.resistencia += 3;
        jogador.atributos.velocidade -= 2;
        jogador.status.push({ nome: "King Monkey", turnosRestantes: 2 });
        log = `${jogador.nome} se transformou em King Monkey! +3 força, +3 resistência, -2 velocidade por 2 turnos.`;
        break;
        
      case "usarForcaMagica":
        if (hab.ativo) {
          logTexto(`${jogador.nome} já está usando Força Mágica.`);
          return;
        }
        hab.ativo = true;
        hab.duracao = 3;
        // Define bônus baseado no ambiente
        if (ambienteAtual === "magico") {
          hab.bonus = 3;
          log = `${jogador.nome} ativou Usar Força Mágica! +3 inteligência por 3 turnos (ambiente mágico).`;
        } else {
          hab.bonus = 1;
          log = `${jogador.nome} ativou Usar Força Mágica! +1 inteligência por 3 turnos.`;
        }
        jogador.atributos.inteligencia += hab.bonus;
        jogador.status.push({ nome: "Usar Força Mágica", turnosRestantes: 3 });
        break;
        
      default:
        log = `${jogador.nome} usou ${hab.nome}, mas o efeito não está implementado.`;
        break;
    }
    
    if (log) logTexto(log);
    atualizarInterface();
  }

  // Mostra diálogo para selecionar item
  function mostrarDialogoItens(jogador) {
    if (dialogoHabilidadeAberto) return;
    dialogoHabilidadeAberto = true;
    
    const dialog = document.createElement("div");
    dialog.className = "dialogo-habilidade";
    
    const overlay = document.createElement("div");
    overlay.className = "overlay";
    
    const titulo = document.createElement("h3");
    titulo.innerText = `${jogador.nome} - Escolha um item`;
    dialog.appendChild(titulo);
    
    const select = document.createElement("select");
    select.id = "selectItem";
    
    if (jogador.inventario.length === 0) {
      const option = document.createElement("option");
      option.value = "";
      option.text = "Inventário vazio";
      select.appendChild(option);
      select.disabled = true;
    } else {
      jogador.inventario.forEach((item, index) => {
        let disponivel = true;
        let motivo = "";
        
        if (item.cooldown && item.cooldown > 0) {
          disponivel = false;
          motivo = ` (CD: ${item.cooldown})`;
        }
        
        const option = document.createElement("option");
        option.value = index;
        option.text = item.nome + motivo;
        option.disabled = !disponivel;
        select.appendChild(option);
      });
    }
    
    dialog.appendChild(select);
    
    const botoesDiv = document.createElement("div");
    botoesDiv.style.marginTop = "10px";
    
    const btnUsar = document.createElement("button");
    btnUsar.innerText = "Usar";
    btnUsar.onclick = () => {
      const itemIndex = parseInt(select.value);
      if (!isNaN(itemIndex)) {
        usarItemSelecionado(jogador, itemIndex);
      }
      fecharDialogo();
    };
    
    const btnCancelar = document.createElement("button");
    btnCancelar.innerText = "Cancelar";
    btnCancelar.onclick = fecharDialogo;
    
    botoesDiv.appendChild(btnUsar);
    botoesDiv.appendChild(btnCancelar);
    dialog.appendChild(botoesDiv);
    
    const descricaoDiv = document.createElement("div");
    descricaoDiv.style.marginTop = "10px";
    descricaoDiv.style.fontSize = "12px";
    descricaoDiv.id = "itemDescricao";
    dialog.appendChild(descricaoDiv);
    
    // Atualiza descrição quando muda o item selecionado
    select.onchange = () => {
      const itemIndex = parseInt(select.value);
      if (!isNaN(itemIndex) && jogador.inventario[itemIndex]) {
        descricaoDiv.innerText = jogador.inventario[itemIndex].descricao;
      } else {
        descricaoDiv.innerText = "";
      }
    };
    
    // Mostra descrição do primeiro item
    if (jogador.inventario.length > 0) {
      descricaoDiv.innerText = jogador.inventario[0].descricao;
    }
    
    document.body.appendChild(overlay);
    document.body.appendChild(dialog);
    
    function fecharDialogo() {
      document.body.removeChild(overlay);
      document.body.removeChild(dialog);
      dialogoHabilidadeAberto = false;
    }
  }

  // Usa o item selecionado no diálogo
  function usarItemSelecionado(jogador, itemIndex) {
    if (itemIndex < 0 || itemIndex >= jogador.inventario.length) return;
    
    const item = jogador.inventario[itemIndex];
    let log = "";
    
    switch (item.nome) {
      case "Catalisador":
        if (item.preparando) {
          logTexto(`${jogador.nome} já está preparando o Catalisador.`);
          return;
        }
        item.preparando = true;
        jogador.status.push({ nome: "Preparando Catalisador", turnosRestantes: 2 });
        log = `${jogador.nome} começou a preparar o Catalisador. Escudo será ativado em 2 turnos.`;
        break;
        
      case "Luvas Solares":
        if (item.cooldown > 0) {
          logTexto(`${jogador.nome} não pode usar as Luvas Solares ainda (CD: ${item.cooldown}).`);
          return;
        }
        if (item.danoAcumulado > 0) {
          // Libera o dano acumulado
          jogador.status.push({ nome: "Dano Acumulado", turnosRestantes: 1 });
          log = `${jogador.nome} prepara-se para liberar ${item.danoAcumulado} de dano acumulado!`;
        } else {
          item.cooldown = 5;
          log = `${jogador.nome} ativou as Luvas Solares! Agora acumulará dano recebido.`;
        }
        break;
        
      case "Manopla Etherflux":
        if (!item.preparada) {
          logTexto(`${jogador.nome} precisa preparar a Manopla Etherflux primeiro.`);
          return;
        }
        // Implementar funcionalidades específicas da manopla
        log = `${jogador.nome} usou a Manopla Etherflux!`;
        // Pode adicionar efeitos específicos aqui
        break;
        
      case "Adagas Duplas":
        if (item.venenoUsado) {
          logTexto(`${jogador.nome} já usou o veneno das Adagas Duplas nesta batalha.`);
          return;
        }
        // O veneno é aplicado no ataque, não diretamente aqui
        log = `${jogador.nome} preparou o veneno das Adagas Duplas para o próximo ataque!`;
        break;
        
      default:
        log = `${jogador.nome} usou ${item.nome}, mas o efeito não está implementado.`;
        break;
    }
    
    if (log) logTexto(log);
    atualizarInterface();
  }

  // Função principal para realizar um turno de ataque
  function realizarTurno() {
    if (!combateAtivo) return;

    const atacanteKey = turno % 2 === 0 ? "player1" : "player2";
    const defensorKey = turno % 2 === 0 ? "player2" : "player1";

    const atacante = estadoJogador[atacanteKey];
    const defensor = estadoJogador[defensorKey];

    if (!atacante || !defensor) return;

    logTexto(`--- Turno ${turno + 1} ---`);
    logTexto(`Atacante: ${atacante.nome}`);
    logTexto(`Defensor: ${defensor.nome}`);

    // Processa efeitos de status no início do turno
    let logStatusAtacante = processarStatus(atacante);
    let logStatusDefensor = processarStatus(defensor);
    if (logStatusAtacante) logTexto(logStatusAtacante);
    if (logStatusDefensor) logTexto(logStatusDefensor);

    // Verifica Tecelão de Carcaças (Malgorr) se estiver morto
    if (atacante.vida <= 0 && atacante.nome === "Malgorr" && !atacante.habilidades.tecelaoCarcacas.usado && defensor.vida <= 0) {
      logTexto(`${atacante.nome} ativa Tecelão de Carcaças!`);
      atacante.vida = Math.floor(atacante.vidaMax * 0.5);
      atacante.habilidades.tecelaoCarcacas.usado = true;
      logTexto(`${atacante.nome} ressuscitou com 50% de vida!`);
    }
    
    if (defensor.vida <= 0 && defensor.nome === "Malgorr" && !defensor.habilidades.tecelaoCarcacas.usado && atacante.vida <= 0) {
      logTexto(`${defensor.nome} ativa Tecelão de Carcaças!`);
      defensor.vida = Math.floor(defensor.vidaMax * 0.5);
      defensor.habilidades.tecelaoCarcacas.usado = true;
      logTexto(`${defensor.nome} ressuscitou com 50% de vida!`);
    }

    if (atacante.vida <= 0) {
      logTexto(`${atacante.nome} está incapacitado e não pode atacar.`);
      turno++;
      atualizarInterface();
      checarVencedor();
      return;
    }
    if (defensor.vida <= 0) {
      logTexto(`${defensor.nome} já está incapacitado.`);
      turno++;
      atualizarInterface();
      checarVencedor();
      return;
    }

    // Se defensor está invisível, atacante erra o ataque automaticamente
    if (estaInvisivel(defensor)) {
      logTexto(`${defensor.nome} está invisível! Ataque falhou.`);
      turno++;
      atualizarInterface();
      return;
    }

    // Calcular acerto
    const dadoAcerto = rolarDado(20);
    let acerto = dadoAcerto + atacante.atributos.velocidade;
    
    // Bônus de Vantagem Elemental
    if (atacante.habilidades.vantagemElemental?.ativo) {
      acerto += 2;
      logTexto(`Bônus de Vantagem Elemental: +2 no acerto`);
    }
    
    const dadoEsquiva = rolarDado(12);
    let esquiva = dadoEsquiva + defensor.atributos.velocidade;
    
    // Bônus de Frenesi de Esquivas (Mu)
    if (ehMu(defensor)) {
      esquiva += defensor.habilidades.frenesiEsquivas.bonusVelocidade;
      if (defensor.habilidades.frenesiEsquivas.bonusVelocidade > 0) {
        logTexto(`Bônus de Frenesi de Esquivas: +${defensor.habilidades.frenesiEsquivas.bonusVelocidade} na esquiva`);
      }
    }

    logTexto(`Rolagem acerto: d20(${dadoAcerto}) + velocidade(${atacante.atributos.velocidade}) = ${acerto}`);
    logTexto(`Rolagem esquiva: d12(${dadoEsquiva}) + velocidade(${defensor.atributos.velocidade}) = ${esquiva}`);

    if (acerto > esquiva) {
      // Acertou
      const dadoDano = rolarDado(12);
      let danoBase;
      
      // Decide se usa força ou inteligência (para magos/tecnomagos)
      if (atacante.classe.toLowerCase() === "mago" || atacante.classe.toLowerCase() === "tecnomago") {
        danoBase = dadoDano * atacante.atributos.inteligencia;
        logTexto(`Dano mágico base: d12(${dadoDano}) * inteligência(${atacante.atributos.inteligencia}) = ${danoBase}`);
      } else {
        danoBase = dadoDano * atacante.atributos.forca;
        logTexto(`Dano físico base: d12(${dadoDano}) * força(${atacante.atributos.forca}) = ${danoBase}`);
      }

      // Aplicar bônus de arma (Rapieira Nobre de Mu)
      if (atacante.nome === "Mu" && atacante.inventario.some(i => i.nome === "Rapieira Nobre")) {
        const bonusForca = Math.floor(atacante.atributos.velocidade / 3);
        danoBase += bonusForca;
        logTexto(`Bônus da Rapieira Nobre: +${bonusForca} de dano`);
      }

      // Aplicar bônus de arma (Luvas Solares de Samuw)
      if (atacante.nome === "Samuw Buoynm" && atacante.inventario.some(i => i.nome === "Luvas Solares")) {
        danoBase += 2; // +2 de força das luvas
        logTexto(`Bônus das Luvas Solares: +2 de dano`);
        
        // Acumula dano nas luvas
        const luvas = atacante.inventario.find(i => i.nome === "Luvas Solares");
        if (luvas) {
          luvas.danoAcumulado += Math.floor(danoBase / 2);
          logTexto(`Luvas Solares acumularam ${Math.floor(danoBase / 2)} de dano (Total: ${luvas.danoAcumulado})`);
        }
      }

      // Aplicar bônus de Vantagem Elemental
      if (atacante.habilidades.vantagemElemental?.ativo) {
        danoBase += 2;
        logTexto(`Bônus de Vantagem Elemental: +2 de dano`);
      }

      // Aplicar bônus de ataque furtivo (Adagas Duplas de Adam)
      if (atacante.nome === "Adam" && atacante.inventario.some(i => i.nome === "Adagas Duplas") && estaInvisivel(atacante)) {
        danoBase = Math.floor(danoBase * 1.3); // 30% a mais de dano
        logTexto(`Ataque furtivo com Adagas Duplas: +30% de dano`);
        
        // Aplica veneno (uma vez por batalha)
        const adagas = atacante.inventario.find(i => i.nome === "Adagas Duplas");
        if (adagas && !adagas.venenoUsado) {
          defensor.status.push({ nome: "Envenenado", turnosRestantes: 3 });
          adagas.venenoUsado = true;
          logTexto(`${defensor.nome} foi envenenado pelas Adagas Duplas por 3 turnos!`);
        }
      }

      // Redução por resistência do defensor
      let danoFinal = danoBase - Math.floor(defensor.atributos.resistencia / 2);
      
      // Redução por escudo do Catalisador
      if (temEscudo(defensor)) {
        danoFinal = Math.floor(danoFinal * 0.5); // 50% de redução
        logTexto(`Escudo do Catalisador reduziu o dano pela metade!`);
      }
      
      if (danoFinal < 0) danoFinal = 0;

      defensor.vida -= danoFinal;
      if (defensor.vida < 0) defensor.vida = 0;

      logTexto(`${atacante.nome} acertou o ataque e causou ${danoFinal} de dano em ${defensor.nome}.`);
      
      // Atualiza esquivas consecutivas para Mu (reset se levar dano)
      if (ehMu(defensor)) {
        defensor.esquivasConsecutivas = 0;
        defensor.habilidades.frenesiEsquivas.esquivasConsecutivas = 0;
      }
    } else {
      // Errou
      logTexto(`${atacante.nome} errou o ataque.`);
      
      // Atualiza esquivas consecutivas para Mu
      if (ehMu(defensor)) {
        defensor.esquivasConsecutivas++;
        defensor.habilidades.frenesiEsquivas.esquivasConsecutivas++;
        logTexto(`${defensor.nome} esquiva (${defensor.esquivasConsecutivas}/2 para Frenesi de Esquivas)`);
        
        // Verifica Frenesi de Esquivas (passiva de Mu)
        if (defensor.esquivasConsecutivas >= 2) {
          defensor.atributos.velocidade += 1;
          defensor.habilidades.frenesiEsquivas.bonusVelocidade += 1;
          defensor.esquivasConsecutivas = 0;
          defensor.habilidades.frenesiEsquivas.esquivasConsecutivas = 0;
          logTexto(`${defensor.nome} ativou Frenesi de Esquivas! +1 de velocidade temporário.`);
        }
      }
    }

    turno++;
    atualizarInterface();
    checarVencedor();
  }

  // Função para checar se alguém venceu
  function checarVencedor() {
    const p1 = estadoJogador.player1;
    const p2 = estadoJogador.player2;

    if (p1 && p1.vida <= 0 && p2 && p2.vida > 0) {
      logTexto(`\n>>> ${p2.nome} venceu o combate! <<<`);
      combateAtivo = false;
      document.getElementById("btnTurno").disabled = true;
      document.getElementById("btnUsarHabilidade").disabled = true;
      document.getElementById("btnUsarItem").disabled = true;
      document.getElementById("btnReiniciar").disabled = false;
    } else if (p2 && p2.vida <= 0 && p1 && p1.vida > 0) {
      logTexto(`\n>>> ${p1.nome} venceu o combate! <<<`);
      combateAtivo = false;
      document.getElementById("btnTurno").disabled = true;
      document.getElementById("btnUsarHabilidade").disabled = true;
      document.getElementById("btnUsarItem").disabled = true;
      document.getElementById("btnReiniciar").disabled = false;
    } else if (p1 && p1.vida <= 0 && p2 && p2.vida <= 0) {
      logTexto(`\n>>> Empate! Ambos foram incapacitados. <<<`);
      combateAtivo = false;
      document.getElementById("btnTurno").disabled = true;
      document.getElementById("btnUsarHabilidade").disabled = true;
      document.getElementById("btnUsarItem").disabled = true;
      document.getElementById("btnReiniciar").disabled = false;
    }
  }

  // Usar habilidade do jogador ativo
  function usarHabilidadeJogador() {
    if (!combateAtivo) return;

    const atacanteKey = turno % 2 === 0 ? "player1" : "player2";
    const atacante = estadoJogador[atacanteKey];
    if (!atacante) return;

    mostrarDialogoHabilidades(atacante);
  }

  // Usar item do jogador ativo
  function usarItemJogador() {
    if (!combateAtivo) return;

    const jogadorKey = turno % 2 === 0 ? "player1" : "player2";
    const jogador = estadoJogador[jogadorKey];
    if (!jogador) return;

    mostrarDialogoItens(jogador);
  }

  // Inicializa selects com personagens
  function inicializarSelects() {
    const sel1 = document.getElementById("selPlayer1");
    const sel2 = document.getElementById("selPlayer2");
    const selAmbiente = document.getElementById("selAmbiente");
    
    // Limpa selects
    sel1.innerHTML = '';
    sel2.innerHTML = '';
    selAmbiente.innerHTML = '';
    
    // Preenche personagens
    for (const chave in personagensBase) {
      const opt1 = document.createElement("option");
      opt1.value = chave;
      opt1.text = personagensBase[chave].nome;
      sel1.appendChild(opt1);

      const opt2 = document.createElement("option");
      opt2.value = chave;
      opt2.text = personagensBase[chave].nome;
      sel2.appendChild(opt2);
    }
    
    // Preenche ambientes
    for (const amb in ambientes) {
      const opt = document.createElement("option");
      opt.value = amb;
      opt.text = ambientes[amb].nome;
      selAmbiente.appendChild(opt);
    }
  }

  // Iniciar combate com personagens selecionados
  function iniciarCombate() {
    const sel1 = document.getElementById("selPlayer1");
    const sel2 = document.getElementById("selPlayer2");
    const selAmbiente = document.getElementById("selAmbiente");
    const chave1 = sel1.value;
    const chave2 = sel2.value;
    ambienteAtual = selAmbiente.value;

    if (chave1 === chave2) {
      alert("Escolha personagens diferentes para os jogadores.");
      return;
    }

    estadoJogador.player1 = criarPersonagem(chave1);
    estadoJogador.player2 = criarPersonagem(chave2);
    
    // Aplica bônus do ambiente
    aplicarBonusAmbiente(estadoJogador.player1);
    aplicarBonusAmbiente(estadoJogador.player2);

    turno = 0;
    combateAtivo = true;

    document.getElementById("btnTurno").disabled = false;
    document.getElementById("btnUsarHabilidade").disabled = false;
    document.getElementById("btnUsarItem").disabled = false;
    document.getElementById("btnReiniciar").disabled = false;
    document.getElementById("btnIniciar").disabled = true;

    document.getElementById("log").innerText = "";
    logTexto("Combate iniciado entre:");
    logTexto(`${estadoJogador.player1.nome} (Jogador 1) VS ${estadoJogador.player2.nome} (Jogador 2)\n`);
    logTexto(`Ambiente: ${ambientes[ambienteAtual].nome}\n`);
    atualizarInterface();
  }

  // Reiniciar jogo
  function reiniciar() {
    estadoJogador.player1 = null;
    estadoJogador.player2 = null;
    turno = 0;
    combateAtivo = false;

    document.getElementById("btnTurno").disabled = true;
    document.getElementById("btnUsarHabilidade").disabled = true;
    document.getElementById("btnUsarItem").disabled = true;
    document.getElementById("btnReiniciar").disabled = true;
    document.getElementById("btnIniciar").disabled = false;

    document.getElementById("log").innerText = "";
    atualizarInterface();
  }

  // Configuração inicial
  inicializarSelects();

  // Eventos dos botões
  document.getElementById("btnIniciar").onclick = iniciarCombate;
  document.getElementById("btnTurno").onclick = realizarTurno;
  document.getElementById("btnUsarHabilidade").onclick = usarHabilidadeJogador;
  document.getElementById("btnUsarItem").onclick = usarItemJogador;
  document.getElementById("btnReiniciar").onclick = reiniciar;

})();
</script>

</body>
</html>